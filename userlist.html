<!DOCTYPE html>
<html lang="en">

<head>

    <!-- Basic -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1, user-scalable=0">

    <!-- Site Metas -->
    <title>Food Funday Restaurant - One page HTML Responsive</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Site Icons -->
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- Site CSS -->
    <link rel="stylesheet" href="css/style.css">
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="css/responsive.css">
    <!-- color -->
    <link id="changeable-colors" rel="stylesheet" href="css/colors/orange.css" />

    <!-- Modernizer -->
    <script src="js/modernizer.js"></script>

</head>
<style>
    body {
      background-color: #f8f9fa;
    }
    .form-container {
      max-width: 80%;
      margin: 40px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    }
    .form-header {
      text-align: center;
      margin-bottom: 20px;
    }
    #site-header {
    background-color: black;
}
.auth-required {
    display: none;
}

.logout-btn {
    display: none;
}

   
  </style>

<body>
    <div id="loader">
        <div id="status"></div>
    </div>
    <div id="site-header">
        <header id="header">
            <div class="container">
                <div class="row">
                    <div class="main-menu">
                        <!-- navbar -->
                        <nav class="navbar navbar-default" id="mainNav">
                            <div class="navbar-header">
                                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                                    <span class="sr-only">Toggle navigation</span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                </button>
                                <div class="logo">
                                    <a class="navbar-brand js-scroll-trigger logo-header" href="#">
                                        <img src="images/logo.png" alt="">
                                    </a>
                                </div>
                            </div>
                            <div id="navbar" class="navbar-collapse collapse">
                                <ul class="nav navbar-nav navbar-right">
                                    <li class="active"><a href="#banner">Home</a></li>
                                    <li><a href="#about">About us</a></li>
                                    <li><a href="#menu">Our Services</a></li>
                                    <li><a href="#our_team">News</a></li>
                                    <li><a href="#footer">Contact us</a></li>
                                    <li><a href="./stockAllocationForm.html">Stakeholders Certificate</a></li>
                                    <!-- <li><a href="./login.html">Login</a></li> -->
                                 
                                    <li class="nav-item" onclick="logout()"><a class="nav-link" > Logout</a></li>
                                </ul>
                            </div>
                            <!-- end nav-collapse -->
                        </nav>
                        <!-- end navbar -->
                    </div>
                </div>
                <!-- end row -->
            </div>
            <!-- end container-fluid -->
        </header>
        <!-- end header -->
    </div>
	<!-- end site-header -->




    <div class="container-fluid pt-4" style="padding: 20px;">
        <div class="card shadow-sm" style="background-color: white;">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Stock Allocation List</h5>
                <!-- <input type="text" class="form-control form-control-sm w-auto" placeholder="Search..." id="searchInput"> -->
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-light">
                            <tr>
                                                             <th>Date</th>
                                <th>Name(s) of Holder(s)</th>
                                <th>Occupation</th>
                                <th>Address</th>
                                <th>Contact No.</th>
                                <th>Nominee Name And Address</th>
                                <th>Total Amount (â‚¹)</th>
                                <th>Monthly Returns (3%)</th>
                                <th>Yearly Returns (36%)</th>
                                <th>Edit</th>
                                <th>Comfirm</th>
                                <th>Delete</th>

                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted">
                        Showing <span id="startRange">0</span> to <span id="endRange">0</span> of <span id="totalEntries">0</span> entries
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Stock Allocation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Name(s) of Holder(s)</label>
                                <input type="text" class="form-control" id="editName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Occupation</label>
                                <input type="text" class="form-control" id="editOccupation" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-control" id="editAddress" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contact No.</label>
                                <input type="text" class="form-control" id="editContact" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Place</label>
                                <input type="text" class="form-control" id="editPlace" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Nominee Name & Address</label>
                                <input type="text" class="form-control" id="editNominee" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Total Amount</label>
                                <input type="number" class="form-control" id="editAmount" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="editdate" readonly style="background-color: #95A5A6;">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Valid Till Date</label>
                                <input type="date" class="form-control" id="editValidTill" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="footer" class="footer-main">
        
        <!-- end footer-news -->
        <div class="footer-box pad-top-70">
            <div class="container">
                <div class="row">
                    <div class="footer-in-main">
                        <div class="footer-logo">
                            <div class="text-center">
                                <img src="images/logo.png" alt="" />
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
                            <div class="footer-box-a">
                                <h3>About Us</h3>
                                <p>Aenean commodo ligula eget dolor aenean massa. Cum sociis nat penatibu set magnis dis parturient montes.</p>
                                <ul class="socials-box footer-socials pull-left">
                                    <li>
                                        <a href="#">
                                            <div class="social-circle-border"><i class="fa  fa-facebook"></i></div>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#">
                                            <div class="social-circle-border"><i class="fa fa-twitter"></i></div>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#">
                                            <div class="social-circle-border"><i class="fa fa-google-plus"></i></div>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#">
                                            <div class="social-circle-border"><i class="fa fa-pinterest"></i></div>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="#">
                                            <div class="social-circle-border"><i class="fa fa-linkedin"></i></div>
                                        </a>
                                    </li>
                                </ul>

                            </div>
                            <!-- end footer-box-a -->
                        </div>
                        <!-- end col -->
                        <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
                            <div class="footer-box-b">
                                <h3>New Menu</h3>
                                <ul>
                                    <li><a href="#">Italian Bomba Sandwich</a></li>
                                    <li><a href="#">Double Dose of Pork Belly</a></li>
                                    <li><a href="#">Spicy Thai Noodles</a></li>
                                    <li><a href="#">Triple Truffle Trotters</a></li>
                                </ul>
                            </div>
                            <!-- end footer-box-b -->
                        </div>
                        <!-- end col -->
                        <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
                            <div class="footer-box-c">
                                <h3>Contact Us</h3>
                                <p>
                                    <i class="fa fa-map-signs" aria-hidden="true"></i>
                                    <span>6 E Esplanade, St Albans VIC 3021, Australia</span>
                                </p>
                                <p>
                                    <i class="fa fa-mobile" aria-hidden="true"></i>
                                    <span>
									+91 80005 89080 
								</span>
                                </p>
                                <p>
                                    <i class="fa fa-envelope" aria-hidden="true"></i>
                                    <span><a href="#">support@foodfunday.com</a></span>
                                </p>
                            </div>
                            <!-- end footer-box-c -->
                        </div>
                        <!-- end col -->
                        <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
                            <div class="footer-box-d">
                                <h3>Opening Hours</h3>

                                <ul>
                                    <li>
                                        <p>Monday - Thursday </p>
                                        <span> 11:00 AM - 9:00 PM</span>
                                    </li>
                                    <li>
                                        <p>Friday - Saturday </p>
                                        <span>  11:00 AM - 5:00 PM</span>
                                    </li>
                                </ul>
                            </div>
                            <!-- end footer-box-d -->
                        </div>
                        <!-- end col -->
                    </div>
                    <!-- end footer-in-main -->
                </div>
                <!-- end row -->
            </div>
            <!-- end container -->
            <div id="copyright" class="copyright-main">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                            <h6 class="copy-title"> Copyright &copy; 2017 Food Funday is powered by <a href="#" target="_blank"></a> </h6>
                        </div>
                    </div>
                    <!-- end row -->
                </div>
                <!-- end container -->
            </div>
            <!-- end copyright-main -->
        </div>
        <!-- end footer-box -->
    </div>
    <!-- end footer-main -->

    <a href="#" class="scrollup" style="display: none;">Scroll</a>

    <section id="color-panel" class="close-color-panel">
        <a class="panel-button gray2"><i class="fa fa-cog fa-spin fa-2x"></i></a>
        <!-- Colors -->
        <div class="segment">
            <h4 class="gray2 normal no-padding">Color Scheme</h4>
            <a title="orange" class="switcher orange-bg"></a>
            <a title="strong-blue" class="switcher strong-blue-bg"></a>
            <a title="moderate-green" class="switcher moderate-green-bg"></a>
            <a title="vivid-yellow" class="switcher vivid-yellow-bg"></a>
        </div>
    </section>

    <!-- ALL JS FILES -->
    <script src="js/all.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- ALL PLUGINS -->
    <script src="js/custom.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 0;
        let currentEditId = null;
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));

        // function toggleLoading(show) {
        //     document.querySelector('.loading-spinner').style.display = show ? 'block' : 'none';
        //     document.querySelector('.overlay').style.display = show ? 'block' : 'none';
        // }

        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('en-GB');
        }

        function calculateReturns(amount) {
            const monthlyRate = 0.03;
            const yearlyRate = 0.36;
            return {
                monthly: amount * monthlyRate,
                yearly: amount * yearlyRate
            };
        }

        async function fetchData(page = 0) {
            // toggleLoading(true);
            try {
                const response = await fetch(`https://mumbailocal.org:8084/api/v1/admin/pending-requests?page=${page}`);
                if (!response.ok) throw new Error('Failed to fetch data');
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading data');
                return { content: [], currentPage: 0, totalPages: 0, totalItems: 0 };
            } finally {
                // toggleLoading(false);
            }
        }

        async function displayData(page) {
            const data = await fetchData(page);
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            data.content.forEach(item => {
                const amount = parseFloat(item.totalAmount);
                const returns = calculateReturns(amount);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                                     <td>${formatDate(item.date?item.date:item.validTill)}</td>
                    <td>${item.nameOfHolders}</td>
                    <td>${item.occupation}</td>
                    <td>${item.address}</td>
                    <td>${item.contactNo}</td>
                    <td>${item.nomineeNameAndAddress}</td>
                    <td>â‚¹${amount.toLocaleString()}</td>
                    <td>â‚¹${returns.monthly.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                    <td>â‚¹${returns.yearly.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                   
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editItem('${item.id}')">Edit</button>
                    </td>
                    <td>
                         <button class="btn btn-sm btn-success" onclick="confirmItem('${item.id}', '${item.contactNo}', '${item.nameOfHolders}')" ${item.verified ? 'disabled' : ''}>
                             ${item.verified ? 'Verified' : 'Confirm'}
                                  </button>
                    </td>
                    <td>
                         <button class="btn btn-sm btn-danger" onclick="deleteItem('${item.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            updatePagination(data.totalPages);
            updateRange(page * data.content.length + 1, 
                       Math.min((page + 1) * data.content.length, data.totalItems), 
                       data.totalItems);
        }

       
let currentEditData = null; // Global variable to store fetched data

async function editItem(id) {
    currentEditId = id;
    // toggleLoading(true);
    try {
        const response = await fetch(`https://mumbailocal.org:8084/api/v1/${id}`);
        if (!response.ok) throw new Error('Failed to fetch item');
        currentEditData = await response.json(); // Store fetched data globally
console.log( currentEditData.date," currentEditData.date")
        // Populate form
        document.getElementById('editName').value = currentEditData.nameOfHolders;
        document.getElementById('editOccupation').value = currentEditData.occupation;
        document.getElementById('editAddress').value = currentEditData.address;
        document.getElementById('editContact').value = currentEditData.contactNo;
        document.getElementById('editPlace').value = currentEditData.place;
        document.getElementById('editNominee').value = currentEditData.nomineeNameAndAddress;
        document.getElementById('editAmount').value = currentEditData.totalAmount;
        document.getElementById('editValidTill').value = currentEditData.validTill.split('T')[0];
        document.getElementById('editdate').value = currentEditData.date.split('T')[0];

        editModal.show();
    } catch (error) {
        console.error('Error:', error);
        alert('Error loading item details');
    } finally {
        // toggleLoading(false);
    }
}

async function saveEdit() {
    if (!currentEditId || !currentEditData) return;

    // Retrieve the date value from the input field
    const validTillValue = document.getElementById('editValidTill').value;
    const validTill = validTillValue
        ? new Date(validTillValue).toISOString() // Convert to ISO 8601 format
        : currentEditData.validTill; // Use the existing validTill value if input is empty
        const datevalue =document.getElementById('editdate').value;
const eddate =datevalue ? new Date(datevalue).toISOString() // Convert to ISO 8601 format
: currentEditData.datevalue; 
    const payload = {
        nameOfHolders: document.getElementById('editName').value,
        occupation: document.getElementById('editOccupation').value,
        address: document.getElementById('editAddress').value,
        contactNo: document.getElementById('editContact').value,
        nomineeNameAndAddress: document.getElementById('editNominee').value,
        totalAmount: parseFloat(document.getElementById('editAmount').value),
        validTill: validTill,
        certificateURL: "certificate",
        certificateNo: currentEditData.certificateNo, // Use certificateNo from currentEditData
        date:eddate,
        place: document.getElementById('editPlace').value
    };

    // toggleLoading(true);
    try {
        const response = await fetch(`https://mumbailocal.org:8084/api/v1/admin/edit/${currentEditId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error('Failed to update');

        alert('Updated successfully');
        editModal.hide();
        displayData(currentPage);
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating item');
    } finally {
        // toggleLoading(false);
    }
}



        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
            prevLi.innerHTML = '<a class="page-link" href="#">Previous</a>';
            prevLi.onclick = () => {
                if (currentPage > 0) {
                    currentPage--;
                    displayData(currentPage);
                }
            };
            pagination.appendChild(prevLi);

            // Page numbers
            for (let i = 0; i < totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${currentPage === i ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i + 1}</a>`;
                li.onclick = () => {
                    currentPage = i;
                    displayData(currentPage);
                };
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
            nextLi.innerHTML = '<a class="page-link" href="#">Next</a>';
            nextLi.onclick = () => {
                if (currentPage < totalPages - 1) {
                    currentPage++;
                    displayData(currentPage);
                }
            };
            pagination.appendChild(nextLi);
        }

        function updateRange(start, end, total) {
            document.getElementById('startRange').textContent = start;
            document.getElementById('endRange').textContent = end;
            document.getElementById('totalEntries').textContent = total;
        }

        // Search functionality
        // let searchTimeout;
        // document.getElementById('searchInput').addEventListener('input', function(e) {
        //     clearTimeout(searchTimeout);
        //     searchTimeout = setTimeout(() => {
        //         currentPage = 0;
        //         displayData(currentPage);
        //     }, 500);
        // });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            displayData(currentPage);
        });



        // delete data
        async function deleteItem(id) {
         
    if (!confirm('Are you sure you want to delete this ?')) {
        return;
    }

    // toggleLoading(true);
    try {
        const response = await fetch(`https://mumbailocal.org:8084/api/v1/admin/delete/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to delete item');
        }

        alert('Record deleted successfully');
        // Refresh the data
        displayData(currentPage);
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting item. Please try again.');
    } finally {
        // toggleLoading(false);
    }
}
    
    // confirm data
async function confirmItem(id, contactNo, nameOfHolders) {
    if (!confirm('Are you sure you want to confirm this application?')) {
        return;
    }

    // toggleLoading(true);
    try {
        const response = await fetch(`https://mumbailocal.org:8084/api/v1/admin/verify/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to confirm item');
        }

        const result = await response.json();
        
        if (result.data && result.data.certificateURL) {
            // Encode the certificate URL properly
            const encodedCertificateURL = result.data.certificateURL.replace(/ /g, '%20');
            
            const message = encodeURIComponent(
                `ðŸŒŸ *Certificate Generated Successfully* ðŸŒŸ\n\n` +
                `Dear *${nameOfHolders}*,\n\n` +
                `Your stock allocation certificate has been generated. Please click the link below to view your certificate:\n\n` +
                `${encodedCertificateURL}\n\n` +
                `*Thank you for choosing ORGANIC KHANDESHI FOOD PRODUCTS.*\n\n` +
                `Best regards,\n` +
                `ORGANIC KHANDESHI FOOD PRODUCTS Team`
            );

            window.open(`https://wa.me/91${contactNo}?text=${message}`, '_blank');
        }

        alert('Application confirmed successfully');
        displayData(currentPage);
    } catch (error) {
        console.error('Error:', error);
        alert('Error confirming application. Please try again.');
    } finally {
        // toggleLoading(false);
    }
}
</script>
<script>
    // Check authentication status and update UI
    function checkAuth() {
    const token = sessionStorage.getItem('token');
    const authRequired = document.querySelectorAll('.auth-required');
    const loginBtn = document.querySelector('.login-btn');
    const logoutBtn = document.querySelector('.logout-btn');

    if (token) {
        // User is logged in
        authRequired.forEach(item => item.style.display = 'block');
        if (loginBtn) loginBtn.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = 'block';
    } else {
        // User is not logged in
        authRequired.forEach(item => item.style.display = 'none');
        if (loginBtn) loginBtn.style.display = 'block';
        if (logoutBtn) logoutBtn.style.display = 'none';
    }
}

function logout() {
    sessionStorage.clear();
    alert('You have been logged out.');
    window.location.href = 'login.html';
}

// Function to redirect to login
function redirectToLogin() {
    window.location.href = 'login.html';
}

// Add protection to pages that require authentication
function protectPage() {
    const token = sessionStorage.getItem('token');
    const currentPage = window.location.pathname;
    
    // List of pages that require authentication
    const protectedPages = ['userlist.html', 'stockAllocationForm.html'];
    
    if (protectedPages.some(page => currentPage.includes(page)) && !token) {
        window.location.href = 'login.html';
    }
}

// Run these when the page loads
document.addEventListener('DOMContentLoaded', () => {
    checkAuth();
    protectPage();
});
</script>
</body>

</html>