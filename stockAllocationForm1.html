<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   
        <!-- Site Icons -->
        <link rel="shortcut icon" href="images/site-favicon.jpeg" type="image/x-icon" />
        <link rel="apple-touch-icon" href="images/site-favicon.jpeg">
        <link rel="icon" href="images/site-favicon.jpeg" type="image/x-icon">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahalakshmi Masale</title> 
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
   
  
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- Site CSS -->
    <!-- <link rel="stylesheet" href="style.css"> -->
    <!-- ALL VERSION CSS -->
    <link rel="stylesheet" href="css/versions.css">
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="css/responsive.css">
    <!-- Custom CSS -->
    <!-- <link rel="stylesheet" href="css/custom.css"> -->
  
    <style>
        .table-responsive {
            max-height: 600px;
        }
        .pagination {
            margin-bottom: 0;
        }
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 14px;
            }
        }
        .shadow-navbar {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000; 
        }
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .top-navbar .navbar-light .navbar-nav .nav-link{
	position: relative;
	padding: 10px 20px;
	color: #ffffff;
}
.top-navbar .navbar-light .navbar-nav .nav-link::after {
	content: "";
    background: #ed2d46;
    z-index: -1;
    width: 10px;
    height: 10px;
    position: absolute;
    bottom: 0;
    left: 0;
	border-radius: 0px 50px 0px 0px; 
    transition: .3s linear;
}
.top-navbar .navbar-light .navbar-nav .nav-item.active .nav-link{
	font-weight: 700;
}
.top-navbar .navbar-light .navbar-nav .nav-item{	
	background: #010101;
	position: relative;
	z-index: 0;
}
.top-navbar .navbar-light .navbar-nav .nav-link:hover::after {
    width: 100%;
    height: 100%;
    border-radius: 0px 15px 0px 0px;
}
.top-navbar .navbar-nav{	
	position: relative;
	z-index: 0;
  
}

.top-navbar1{
    box-shadow: 0px 0px 18px 1px rgba(0, 0, 0, 0.1);
}
    </style>
</head>
<body>
    <!-- Loading spinner -->
    <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="overlay"></div>

    <header class="top-navbar top-navbar1" >
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container">
				<a class="navbar-brand" href="index.html">
					<img src="images/logo.png" alt="" />
				</a>
				<button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbars-rs-food" aria-controls="navbars-rs-food" aria-expanded="false" aria-label="Toggle navigation">
					<span class="icon-bar top-bar"></span>
					<span class="icon-bar middle-bar"></span>
					<span class="icon-bar bottom-bar"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbars-rs-food">
					<ul class="navbar-nav ml-auto">
						<li class="nav-item active"><a class="nav-link" href="index.html">Home</a></li>
					            <li class="nav-item" onclick="logout()"><a class="nav-link" > Logout</a></li>
						
										</ul>
				</div>
			</div>
		</nav>
	</header>

      <!-- <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-navbar">
        <div class="container-fluid d-flex flex-wrap">
          <img src="./image/logo.png" style="height: 30px; width: 30px; margin-right: 5px" />
          <a class="navbar-brand me-auto" href="#">ORGANIC KHANDESHI FOOD</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link" aria-current="page" href="index.html">Dashboard</a>
              </li>

              <li class="nav-item auth-required" style="display: none;">
                <a class="nav-link" href="userlist.html">Applied User List</a>
              </li>
              <li class="nav-item auth-required" style="display: none;">
                <a class="nav-link" href="stockAllocationForm.html">Stock Allocation Form</a>
              </li>
            </ul>
            <form class="d-flex ms-auto">
              <button class="btn btn-outline-primary login-btn" type="button" onclick="redirectToLogin()" style="display: none;">
                Login
              </button>
              <button class="btn btn-outline-danger logout-btn" type="button" onclick="logout()" style="display: none;">
                Logout
              </button>
            </form>
          </div>
        </div>
      </nav> -->
    <!-- Main Content -->
    <div class="container-fluid py-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Stock Allocation List</h5>
                <!-- <input type="text" class="form-control form-control-sm w-auto" placeholder="Search..." id="searchInput"> -->
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-light">
                            <tr>
                                                             <th>Date</th>
                                <th>Name(s) of Holder(s)</th>
                                <th>Occupation</th>
                                <th>Address</th>
                                <th>Contact No.</th>
                                <th>Nominee Name And Address</th>
                                <th>Total Amount (â‚¹)</th>
                                <th>Monthly Returns (3%)</th>
                                <th>Yearly Returns (36%)</th>
                                <th>Edit</th>
                                <th>Comfirm</th>
                                <th>Delete</th>

                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted">
                        Showing <span id="startRange">0</span> to <span id="endRange">0</span> of <span id="totalEntries">0</span> entries
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Stock Allocation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Name(s) of Holder(s)</label>
                                <input type="text" class="form-control" id="editName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Occupation</label>
                                <input type="text" class="form-control" id="editOccupation" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-control" id="editAddress" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contact No.</label>
                                <input type="text" class="form-control" id="editContact" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Place</label>
                                <input type="text" class="form-control" id="editPlace" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Nominee Name & Address</label>
                                <input type="text" class="form-control" id="editNominee" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Total Amount</label>
                                <input type="number" class="form-control" id="editAmount" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="editdate" readonly style="background-color: #95A5A6;">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Valid Till Date</label>
                                <input type="date" class="form-control" id="editValidTill" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 0;
        let currentEditId = null;
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));

        function toggleLoading(show) {
            document.querySelector('.loading-spinner').style.display = show ? 'block' : 'none';
            document.querySelector('.overlay').style.display = show ? 'block' : 'none';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('en-GB');
        }

        function calculateReturns(amount) {
            const monthlyRate = 0.03;
            const yearlyRate = 0.36;
            return {
                monthly: amount * monthlyRate,
                yearly: amount * yearlyRate
            };
        }

        async function fetchData(page = 0) {
            toggleLoading(true);
            try {
                const response = await fetch(`https://mumbailocal.org:8084/api/v1/admin/pending-requests?page=${page}`);
                if (!response.ok) throw new Error('Failed to fetch data');
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading data');
                return { content: [], currentPage: 0, totalPages: 0, totalItems: 0 };
            } finally {
                toggleLoading(false);
            }
        }

        async function displayData(page) {
            const data = await fetchData(page);
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            data.content.forEach(item => {
                const amount = parseFloat(item.totalAmount);
                const returns = calculateReturns(amount);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                                     <td>${formatDate(item.date?item.date:item.validTill)}</td>
                    <td>${item.nameOfHolders}</td>
                    <td>${item.occupation}</td>
                    <td>${item.address}</td>
                    <td>${item.contactNo}</td>
                    <td>${item.nomineeNameAndAddress}</td>
                    <td>â‚¹${amount.toLocaleString()}</td>
                    <td>â‚¹${returns.monthly.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                    <td>â‚¹${returns.yearly.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                   
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editItem('${item.id}')">Edit</button>
                    </td>
                    <td>
                         <button class="btn btn-sm btn-success" onclick="confirmItem('${item.id}', '${item.contactNo}', '${item.nameOfHolders}')" ${item.verified ? 'disabled' : ''}>
                             ${item.verified ? 'Verified' : 'Confirm'}
                                  </button>
                    </td>
                    <td>
                         <button class="btn btn-sm btn-danger" onclick="deleteItem('${item.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            updatePagination(data.totalPages);
            updateRange(page * data.content.length + 1, 
                       Math.min((page + 1) * data.content.length, data.totalItems), 
                       data.totalItems);
        }

       
let currentEditData = null; // Global variable to store fetched data

async function editItem(id) {
    currentEditId = id;
    toggleLoading(true);
    try {
        const response = await fetch(`https://mumbailocal.org:8084/api/v1/${id}`);
        if (!response.ok) throw new Error('Failed to fetch item');
        currentEditData = await response.json(); // Store fetched data globally
console.log( currentEditData.date," currentEditData.date")
        // Populate form
        document.getElementById('editName').value = currentEditData.nameOfHolders;
        document.getElementById('editOccupation').value = currentEditData.occupation;
        document.getElementById('editAddress').value = currentEditData.address;
        document.getElementById('editContact').value = currentEditData.contactNo;
        document.getElementById('editPlace').value = currentEditData.place;
        document.getElementById('editNominee').value = currentEditData.nomineeNameAndAddress;
        document.getElementById('editAmount').value = currentEditData.totalAmount;
        document.getElementById('editValidTill').value = currentEditData.validTill.split('T')[0];
        document.getElementById('editdate').value = currentEditData.date.split('T')[0];

        editModal.show();
    } catch (error) {
        console.error('Error:', error);
        alert('Error loading item details');
    } finally {
        toggleLoading(false);
    }
}

async function saveEdit() {
    if (!currentEditId || !currentEditData) return;

    // Retrieve the date value from the input field
    const validTillValue = document.getElementById('editValidTill').value;
    const validTill = validTillValue
        ? new Date(validTillValue).toISOString() // Convert to ISO 8601 format
        : currentEditData.validTill; // Use the existing validTill value if input is empty
        const datevalue =document.getElementById('editdate').value;
const eddate =datevalue ? new Date(datevalue).toISOString() // Convert to ISO 8601 format
: currentEditData.datevalue; 
    const payload = {
        nameOfHolders: document.getElementById('editName').value,
        occupation: document.getElementById('editOccupation').value,
        address: document.getElementById('editAddress').value,
        contactNo: document.getElementById('editContact').value,
        nomineeNameAndAddress: document.getElementById('editNominee').value,
        totalAmount: parseFloat(document.getElementById('editAmount').value),
        validTill: validTill,
        certificateURL: "certificate",
        certificateNo: currentEditData.certificateNo, // Use certificateNo from currentEditData
        date:eddate,
        place: document.getElementById('editPlace').value
    };

    toggleLoading(true);
    try {
        const response = await fetch(`https://mumbailocal.org:8084/api/v1/admin/edit/${currentEditId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error('Failed to update');

        alert('Updated successfully');
        editModal.hide();
        displayData(currentPage);
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating item');
    } finally {
        toggleLoading(false);
    }
}



        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
            prevLi.innerHTML = '<a class="page-link" href="#">Previous</a>';
            prevLi.onclick = () => {
                if (currentPage > 0) {
                    currentPage--;
                    displayData(currentPage);
                }
            };
            pagination.appendChild(prevLi);

            // Page numbers
            for (let i = 0; i < totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${currentPage === i ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i + 1}</a>`;
                li.onclick = () => {
                    currentPage = i;
                    displayData(currentPage);
                };
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
            nextLi.innerHTML = '<a class="page-link" href="#">Next</a>';
            nextLi.onclick = () => {
                if (currentPage < totalPages - 1) {
                    currentPage++;
                    displayData(currentPage);
                }
            };
            pagination.appendChild(nextLi);
        }

        function updateRange(start, end, total) {
            document.getElementById('startRange').textContent = start;
            document.getElementById('endRange').textContent = end;
            document.getElementById('totalEntries').textContent = total;
        }

        // Search functionality
        // let searchTimeout;
        // document.getElementById('searchInput').addEventListener('input', function(e) {
        //     clearTimeout(searchTimeout);
        //     searchTimeout = setTimeout(() => {
        //         currentPage = 0;
        //         displayData(currentPage);
        //     }, 500);
        // });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            displayData(currentPage);
        });



        // delete data
        async function deleteItem(id) {
         
    if (!confirm('Are you sure you want to delete this ?')) {
        return;
    }

    toggleLoading(true);
    try {
        const response = await fetch(`https://mumbailocal.org:8084/api/v1/admin/delete/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to delete item');
        }

        alert('Record deleted successfully');
        // Refresh the data
        displayData(currentPage);
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting item. Please try again.');
    } finally {
        toggleLoading(false);
    }
}
    
    // confirm data
async function confirmItem(id, contactNo, nameOfHolders) {
    if (!confirm('Are you sure you want to confirm this application?')) {
        return;
    }

    toggleLoading(true);
    try {
        const response = await fetch(`https://mumbailocal.org:8084/api/v1/admin/verify/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to confirm item');
        }

        const result = await response.json();
        
        if (result.data && result.data.certificateURL) {
            // Encode the certificate URL properly
            const encodedCertificateURL = result.data.certificateURL.replace(/ /g, '%20');
            
            const message = encodeURIComponent(
                `ðŸŒŸ *Certificate Generated Successfully* ðŸŒŸ\n\n` +
                `Dear *${nameOfHolders}*,\n\n` +
                `Your stock allocation certificate has been generated. Please click the link below to view your certificate:\n\n` +
                `${encodedCertificateURL}\n\n` +
                `*Thank you for choosing ORGANIC KHANDESHI FOOD PRODUCTS.*\n\n` +
                `Best regards,\n` +
                `ORGANIC KHANDESHI FOOD PRODUCTS Team`
            );

            window.open(`https://wa.me/91${contactNo}?text=${message}`, '_blank');
        }

        alert('Application confirmed successfully');
        displayData(currentPage);
    } catch (error) {
        console.error('Error:', error);
        alert('Error confirming application. Please try again.');
    } finally {
        toggleLoading(false);
    }
}
</script>
<script>
    // Check authentication status and update UI
function checkAuth() {
    const token = sessionStorage.getItem('token');
    const authRequired = document.querySelectorAll('.auth-required');
    const loginBtn = document.querySelector('.login-btn');
    const logoutBtn = document.querySelector('.logout-btn');

    if (token) {
        // User is logged in
        authRequired.forEach(item => item.style.display = 'block');
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'block';
    } else {
        // User is not logged in
        authRequired.forEach(item => item.style.display = 'none');
        loginBtn.style.display = 'block';
        logoutBtn.style.display = 'none';
    }
}

// Function to handle logout
function logout() {
    sessionStorage.clear();
    alert('You have been logged out.');
    window.location.href = 'login.html';
}

// Function to redirect to login
function redirectToLogin() {
    window.location.href = 'login.html';
}

// Add protection to pages that require authentication
function protectPage() {
    const token = sessionStorage.getItem('token');
    const currentPage = window.location.pathname;
    
    // List of pages that require authentication
    const protectedPages = ['userlist.html', 'stockAllocationForm.html'];
    
    if (protectedPages.some(page => currentPage.includes(page)) && !token) {
        window.location.href = 'login.html';
    }
}

// Run these when the page loads
document.addEventListener('DOMContentLoaded', () => {
    checkAuth();
    protectPage();
});
</script>
</body>
</html>